# 画面遷移・ボタン動作の実装指示

## 概要
LP内の全ボタン・リンクが正しく画面遷移するよう実装してください。
以下に「どのボタンを押したら → どこに遷移し → 何が起きるか」を全て定義します。

---

## ページ構成（おさらい）

```
/           … LPメインページ（SCREEN 1）
/booking    … 予約ページ（Googleフォーム埋め込み or リンク）
/thanks     … リクエスト完了（任意。フォーム自体に完了画面あり）
/terms      … 利用規約
/privacy    … プライバシーポリシー
```

---

## 全ボタン・リンクの遷移マップ

### `/` LPメインページ

| # | 要素の場所 | ボタン/リンクのテキスト | 押した時の動作 |
|---|-----------|----------------------|---------------|
| 1 | Header（固定） | 「Book Now」 | `/booking` へ遷移（スムーズスクロールではなくページ遷移） |
| 2 | Hero セクション | 「体験を予約する ▼」 | `/booking` へ遷移 |
| 3 | 体験カード（9つ） | カード全体をタップ | そのカードの詳細モーダル（ボトムシート）を表示。ページ遷移はしない |
| 4 | 体験詳細モーダル内 | 「この体験を含めて予約する ▼」 | `/booking?preselect=tate` のようにクエリパラメータで体験IDを渡して遷移。遷移先のStep 3で該当の体験が選択済み状態になる |
| 5 | 体験詳細モーダル内 | 「✕」閉じるボタン | モーダルを閉じる。ページ遷移しない |
| 6 | 体験詳細モーダル | 背景の暗い部分タップ | モーダルを閉じる |
| 7 | 空き状況カレンダー | 「◀ 前月」「翌月 ▶」 | 月切替。GAS WebAppに該当月のavailabilityをfetchし直す |
| 8 | 空き状況カレンダー | 空き枠のある日付タップ | `/booking`へ遷移（パターンCならprefillで日付を渡す） |
| 9 | 空き状況カレンダー | 全枠満席の日付タップ | 何も起きない（グレーアウト+「満席」表示、タップ不可） |
| 10 | CTA セクション | 「▼ 予約フォームへ」 | `/booking` へ遷移 |
| 11 | Footer | 「利用規約」 | `/terms` へ遷移（別ページ or 別タブ） |
| 12 | Footer | 「プライバシーポリシー」 | `/privacy` へ遷移（別ページ or 別タブ） |
| 13 | Footer | 「Instagram」 | 外部リンク（`target="_blank"`） |
| 14 | Footer | 「YouTube」 | 外部リンク（`target="_blank"`） |

---

### 空き状況カレンダーの動作仕様

LP上に空き状況カレンダーを表示する。GAS WebAppから予約状況をリアルタイム取得し反映する。

**表示ルール：**

| スケジュール管理シートの値 | APIレスポンス | カレンダー表示 | タップ動作 |
|---|---|---|---|
| ◎ | `"available"` | 日付を通常表示。枠ごとに「◎ 空き」（緑） | タップで /booking へ遷移 |
| BK-xxx | `"booked"` | 枠を「✕ 満席」表示（グレー） | 全枠bookedの日はタップ不可 |
| ✕ | `"closed"` | 日付をグレーアウト + 「休業」 | タップ不可 |
| API失敗 | — | 全枠「空き」表示 + 「※最新の空き状況はフォーム送信後に確認します」の注意文言 | タップ可 |

**データ取得タイミング：**
- LP初回表示時に当月分を自動fetch
- 月切替（前月/翌月）タップ時にfetch
- SWR or React Query で5分間キャッシュ（同じ月への再リクエストを防止）

**カレンダーUI：**
- 月表示（カレンダーグリッド）
- 各日付セルの下に4枠のステータスをドットまたは小テキストで表示
  - 例: 「◎◎✕◎」（16:00空き / 18:00空き / 20:00満席 / 22:00空き）
- 1枠でも空きがある日 → タップ可能（枠線付き）
- 全枠満席 or 休業 → グレーアウト + タップ不可

---

### `/booking` 予約ページ（Googleフォーム）

実装パターンにより遷移が異なる。3パターンを定義：

#### パターンA: iframe埋め込み（推奨）

| # | 操作 | 動作 |
|---|------|------|
| 1 | ページ表示 | Googleフォームがiframe内に表示される |
| 2 | フォーム内で送信ボタン | iframe内でGoogleフォームの確認画面が表示される。ページ遷移なし |
| 3 | Header「← LPに戻る」 | `/` へ遷移 |

```tsx
// booking/page.tsx
<div className="max-w-lg mx-auto">
  <iframe
    src={process.env.NEXT_PUBLIC_GOOGLE_FORM_URL + "?embedded=true"}
    width="100%"
    height="900"
    frameBorder={0}
  >
    Loading…
  </iframe>
</div>
```

#### パターンB: ボタンリンク（最もシンプル）

| # | 操作 | 動作 |
|---|------|------|
| 1 | LP上の「予約する」ボタン | Googleフォームを別タブで開く（`target="_blank"`） |
| 2 | フォーム送信 | Googleフォームの確認画面が表示される |

この場合 `/booking` ページ自体が不要。

#### パターンC: カスタムUI → prefill（UX最良）

LP上でカスタムUIで選択 → 選択内容をGoogleフォームのprefillパラメータに変換 → フォームに遷移

| # | 操作 | 動作 |
|---|------|------|
| 1 | LP体験詳細モーダル「この体験を含めて予約する」 | `/booking?preselect=tate` へ遷移 |
| 2 | /booking でカスタムUIで日付・時間・体験を選択 | ページ内で状態管理（ステップ式） |
| 3 | 「予約フォームへ進む」ボタン | 選択内容をprefillパラメータに変換し、Googleフォームを別タブ or 同一タブで開く |

```typescript
// prefill URLの生成例
const buildFormUrl = (date: string, time: string, activities: string[]) => {
  const base = process.env.NEXT_PUBLIC_GOOGLE_FORM_URL;
  const params = new URLSearchParams({
    'usp': 'pp_url',
    'entry.日付フィールドID': date,
    'entry.時間フィールドID': time,
    'entry.体験1フィールドID': activities[0],
    'entry.体験2フィールドID': activities[1],
    'entry.体験3フィールドID': activities[2],
  });
  return `${base}?${params.toString()}`;
};
// → Googleフォームが開いた時点で日付・時間・体験が事前入力されている
```

**パターンCを選ぶ場合のステップ遷移は画面遷移仕様v1（カスタムUI版）を参照。**
ただしStep 4（情報入力）以降はGoogleフォーム側で行うため、カスタムUIはStep 1〜3のみ。

---

### `/booking` からの特殊遷移：クエリパラメータ（パターンCのみ）

LPの体験詳細モーダルから `/booking?preselect=tate` のように遷移した場合：
1. カスタムUI上で `preselect` に指定された体験が選択済み状態になっている
2. ユーザーは残り2つを追加選択し、日付・時間も選ぶ
3. 「予約フォームへ進む」で prefill済みGoogleフォームに遷移

```typescript
const searchParams = useSearchParams();
const preselect = searchParams.get('preselect'); // "tate" など

const [selectedActivities, setSelectedActivities] = useState<string[]>(
  preselect ? [preselect] : []
);
```

---

### フォーム送信後の動線

Googleフォーム送信後はGoogleフォームの確認画面が表示される。

**iframe埋め込み（パターンA）の場合：**
- iframe内に「Thank you! We received your request.」が表示される
- ヘッダーの「← LPに戻る」ボタンで `/` に遷移

**別タブ（パターンB/C）の場合：**
- フォーム送信後、ユーザーはタブを閉じてLPに戻る
- またはフォームの確認画面にLPへのリンクを含めることも可能（Googleフォームのカスタマイズの範囲内）

---

### `/thanks` リクエスト完了ページ（任意）

Googleフォーム自体に送信完了メッセージが表示されるため、このページは必須ではない。
パターンCで独自のサンクスページを表示したい場合のみ実装：

| # | 要素 | 操作 | 動作 |
|---|------|------|------|
| 1 | 「LPに戻る」ボタン | タップ | `/` へ遷移 |
| 2 | 「support@example.com」 | タップ | `mailto:support@example.com` でメールアプリを起動 |

---

## 状態管理まとめ

**パターンA/Bの場合：** 複雑な状態管理は不要。LPのモーダル開閉のみ管理。

**パターンCの場合（カスタムUI → prefill）：** Step 1〜3の選択のみ管理。

```typescript
type BookingSelections = {
  date: string | null;          // "2026-03-07"
  timeSlot: string | null;      // "20:00-21:30"
  activities: string[];         // ["tate", "costume", "tea"]
};
// → この値をprefillパラメータに変換してGoogleフォームURLに付加
```

---

## バリデーション

**Googleフォーム側で行うバリデーション：**
- 必須項目（日付・時間・体験3つ・名前・メール・人数・部屋番号・利用規約同意）
- メールアドレス形式チェック（フォーム設定の「回答の検証」で対応）
- Googleフォームの必須設定で送信を制御

**GAS側で行うバリデーション：**
- 体験の重複チェック（体験①②③が全て異なるか）
- 人数が1〜4の範囲内か
- 該当時間枠がすでに予約済みでないか（スケジュール管理シート参照）
- バリデーション失敗時はゲストにメールで通知

**Next.js（パターンC）側のバリデーション：**
- activities.length === 3 でないと「フォームへ進む」ボタンをdisabled

---

## この指示書の使い方

Cursor AIに以下のように伝えてください：

> 画面遷移を `画面遷移仕様.md` の定義通りに実装してください。
> 予約フォームはGoogleフォーム埋め込みで、Next.js側にAPIルートは不要です。
> 特に以下を重点的に：
> - 体験詳細モーダルの開閉とボトムシートアニメーション
> - LP上の全ての「予約する」ボタンから /booking（Googleフォーム）への導線
> - Footer・ヘッダーの各リンクの遷移先
> - （パターンCの場合）カスタムUIの選択内容をprefillパラメータに変換する処理
